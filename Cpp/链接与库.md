# 链接与库

## 1.Build过程

**预处理**

**编译**

- 词法分析: 通过**有限状态机算法**, 将字符序列分割成一系列的记号(Token, 一系列的单词符号). 
- 语法分析: 对**记号(Token)**进行语法分, 生成**语法树**.
- 语义分析: **静态语义**分析(声明和类型的匹配, 类型转换等.)

**汇编**

**链接**

- 按照一定规则, 将独立编译的代码模块组装在一起.

## 2.目标文件和ELF

> **目标文件**分为: 可重定位目标文件, 可执行目标文件, 共享目标文件. 现代UNIX系统的目标文件格式是ELF.
>
> ELF文件:  ELF头, 段, 段头部.

**段**

- 通过命令`size -A object.o`, 可以查看段的地址和长度.

- ```
    section              size      addr
    .interp                28   4194872
    .note.ABI-tag          32   4194900
    .note.gnu.build-id     36   4194932
    .gnu.hash              28   4194968
    .dynsym                96   4195000
    .dynstr                61   4195096
    .gnu.version            8   4195158
    .gnu.version_r         32   4195168
    .rela.dyn              24   4195200
    .rela.plt              72   4195224
    .init                  26   4195296
    .plt                   64   4195328
    .text                 386   4195392
    .fini                   9   4195780
    .rodata                28   4195792
    .eh_frame_hdr          52   4195820
    .eh_frame             244   4195872
    .init_array             8   6295056
    .fini_array             8   6295064
    .jcr                    8   6295072
    .dynamic              464   6295080
    .got                    8   6295544
    .got.plt               48   6295552
    .data                   4   6295600
    .bss                    4   6295604
    .comment               90         0
    ```

- **`.text` 代码段**: 已编译的机器代码.

- **`.data` 数据段**: 已经初始化了的全局静态变量和局部静态变量.

- **`.rodata` 只读数据段**: 字符串和常量.

- **`.bss`**: 未初始化全局变量和局部静态变量.

- **`.symtab`**: 符号表.在程序中**定义**和**引用**的函数和全局变量符号.包含

    - 1.当前模块中定义, 能被其他模块引用的全局符号.**非静态函数全局变量**.
    - 2.其他模块定义, 被当前模块引用的全局符号.
    - 3.只能被模块m定义和引用的本地符号.

**加载可执行目标文件**

- 通过加载器(`execve()`), 将可执行目标文件中的代码和数据从磁盘拷贝到内存, 然后通过跳转到程序的第一条指令或入口点(entry point)来运行程序.
- 

## 3.链接

> 将各种代码和数据部分收集并组合成为一个单一文件的过程.

**两步链接 Two-pass Linking**

- 第一步**符号解析**: 将符号定义和符号引用联系起来.
- 第二步**重定位**: 把符号定义与存储器位置联系, 然后修改这些符号的引用, 将其指向存储器位置.

**重定位表**

- `objdump -r object.o`

- ```
    RELOCATION RECORDS FOR [.text]:
    OFFSET           TYPE              VALUE 
    0000000000000014 R_X86_64_32       shared
    0000000000000021 R_X86_64_PC32     swap-0x0000000000000004
    ```

    - `RELOCATION RECORDS FOR [.text]:` 表示这个重定向是代码段的重定向表.
    - `OFFSET`: 重定位入口的偏移.

## 静态库

> 一组目标文件的集合, 例如: `/usr/lib/libc.a`

- 

## 动态库

> 共享库(shared library), **在运行时, 加载到任意的内存地址, 并和一个在内存中的程序链接起来(动态链接)**

**工作原理**

- 程序不包含共享库的代码和数据信息, 仅仅拷贝了**重定位和符号表信息**. 减少了程序体积.
- 在内存中, 多个程序通过**共享库的存储器映射**, 共享`.text`段, 减少了内存占用.

**创建共享库**

- 