# 编译链接与库

## 1.Build过程

**预处理**

**编译**

- 词法分析: 通过**有限状态机算法**, 将字符序列分割成一系列的记号(Token, 一系列的单词符号). 
- 语法分析: 对**记号(Token)**进行语法分, 生成**语法树**.
- 语义分析: **静态语义**分析(声明和类型的匹配, 类型转换等.)

**汇编**

**链接**

- 按照一定规则, 将独立编译的代码模块组装在一起.

## 2.目标文件和ELF

**段**

- 通过命令`size -A object.o`, 可以查看段的地址和长度.

- ```
    section              size      addr
    .interp                28   4194872
    .note.ABI-tag          32   4194900
    .note.gnu.build-id     36   4194932
    .gnu.hash              28   4194968
    .dynsym                96   4195000
    .dynstr                61   4195096
    .gnu.version            8   4195158
    .gnu.version_r         32   4195168
    .rela.dyn              24   4195200
    .rela.plt              72   4195224
    .init                  26   4195296
    .plt                   64   4195328
    .text                 386   4195392
    .fini                   9   4195780
    .rodata                28   4195792
    .eh_frame_hdr          52   4195820
    .eh_frame             244   4195872
    .init_array             8   6295056
    .fini_array             8   6295064
    .jcr                    8   6295072
    .dynamic              464   6295080
    .got                    8   6295544
    .got.plt               48   6295552
    .data                   4   6295600
    .bss                    4   6295604
    .comment               90         0
    ```

- **`.text` 代码段**: 

- **`.data` 数据段**: 已经初始化了的全局静态变量和局部静态变量.
- **`.rodata` 只读数据段**: 字符串和常量.
- **`.bss`**: 未初始化全局变量和局部静态变量.
- **`.symtab`**: 符号表.



## 3.链接

**两步链接 Two-pass Linking**

- 第一步: 将所有目标文件中的符号收集, 合并各个目标文件的段. 计算输出文件各段的长度和位置.
- 第二步: 读取输入文件中的重定位信息, 进行重定位.

**重定位表**

- `objdump -r object.o`

- ```
    RELOCATION RECORDS FOR [.text]:
    OFFSET           TYPE              VALUE 
    0000000000000014 R_X86_64_32       shared
    0000000000000021 R_X86_64_PC32     swap-0x0000000000000004
    ```

    - `RELOCATION RECORDS FOR [.text]:` 表示这个重定向是代码段的重定向表.
    - `OFFSET`: 重定位入口的偏移.

## 静态库

> 一组目标文件的集合, 例如: `/usr/lib/libc.a`

### 动态库